{% extends 'base.html' %}

{% block title %}Profile - MetaBrainz Foundation{% endblock %}

{% block content %}
  <h1>Profile</h1>

  <p>
    <strong>Type:</strong>
    {{ 'Commercial' if current_user.is_commercial else 'Non-commercial' }}
    <br />
    <strong>State:</strong>
    <span class="{{ 'text-success' if current_user.state == 'active'   else
                    'text-danger'  if current_user.state == 'rejected' else
                    'text-primary' if current_user.state == 'pending'  else
                    'text-warning' }}">
        {{ current_user.state|upper }}
    </span>
  </p>

  {% if current_user.state == 'active' %}
    <h2>Access token</h2>
    <p>
      <code id="token" style="margin-right:4px; {{ 'display:none;' if not current_user.token }}">{{ current_user.token.value }}</code>
      <a id="btn-generate-token" class="btn btn-default btn-xs" href="#" role="button">Generate new token</a>
    </p>
    <p class="text-muted" style="font-style: italic;">
      This access token should be considered private. Don't check this token
      into any publicly visible version control systems and similar places.
      If token has been exposed, you should immediately generate a new one!
    </p>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if current_user.state == 'active' %}
    <script>
      $(document).ready(function () {
        var token = $("#token");
        {# Not showing confirmation dialog if there's no active token. #}
        var ignoreConfirmation = {{ 'false' if current_user.token else 'true' }};

        $("#btn-generate-token").click(function () {
          if (ignoreConfirmation || confirm('Are you sure you want to generate new access token?\n' +
                                            'Current token will be revoked!')) {
            $.ajax({
              type: "POST",
              url: "{{ url_for('users.regenerate_token') }}",
              success: function (data) {
                token.html(data.token);
                token.show();
                ignoreConfirmation = false;
              },
              error: function () { alert('Failed to generate new access token!'); }
            });
          }
        });
      });
    </script>
  {% endif %}
{% endblock %}
